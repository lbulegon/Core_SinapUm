# CI/CD - Testes Core_SinapUm
# Executa em push e pull_request para main/master
name: Testes

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  unit-tests:
    name: Testes Unitários
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configurar .env para CI
        run: |
          cp .env.Original .env 2>/dev/null || cp .env.example .env 2>/dev/null || touch .env
          [ -f services/openmind_service/.env.example ] && cp services/openmind_service/.env.example services/openmind_service/.env || true
          [ -f services/ddf_service/.env.example ] && cp services/ddf_service/.env.example services/ddf_service/.env || true

      - name: Subir serviços necessários
        run: |
          docker compose up -d db openmind ddf_postgres ddf_redis ddf_service sparkscore_service shopperbot_service web mcp_service
        env:
          POSTGRES_PASSWORD: mcp_password_ci
          POSTGRES_USER: mcp_user
          POSTGRES_DB: mcp_sinapum

      - name: Aguardar serviços
        run: sleep 45

      - name: Testes SparkScore
        run: |
          docker compose run --rm -v $PWD/services/sparkscore_service:/app -e PYTHONPATH=/app sparkscore_service \
            sh -c "pip install -q pytest 'httpx<0.27' && pytest tests/ --ignore=tests/regression/ -v --tb=short"

      - name: Testes ShopperBot
        run: |
          docker compose run --rm -v $PWD/services/shopperbot_service:/app -e PYTHONPATH=/app shopperbot_service \
            sh -c "pip install -q pytest && pytest tests/ -v --tb=short"

  integration-tests:
    name: Testes de Integração
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Configurar .env para CI
        run: |
          cp .env.Original .env 2>/dev/null || cp .env.example .env 2>/dev/null || true
          test -f .env || touch .env
          test -f services/openmind_service/.env.example && cp services/openmind_service/.env.example services/openmind_service/.env || true
          test -f services/ddf_service/.env.example && cp services/ddf_service/.env.example services/ddf_service/.env || true

      - name: Subir stack (serviços essenciais)
        run: |
          docker compose up -d db openmind ddf_postgres ddf_redis ddf_service \
            sparkscore_service shopperbot_service web mcp_service
        env:
          POSTGRES_PASSWORD: mcp_password_ci
          POSTGRES_USER: mcp_user
          POSTGRES_DB: mcp_sinapum

      - name: Aguardar serviços
        run: sleep 60

      - name: Testes de integração
        run: |
          docker run --rm -v $PWD:/app -w /app --network host -e TEST_BASE_HOST=localhost \
            python:3.11-slim bash -c "pip install -q pytest requests && pytest tests/integration/ -v --tb=short"
